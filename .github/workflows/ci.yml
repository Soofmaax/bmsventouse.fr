name: CI - Full Quality Gate

on:
  # Déclenchement automatique sur PR (vérification avant merge)
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: ['**']

  # Déclenchement sur push (toutes branches)
  push:
    branches: ['**']

  # Lancement manuel à la demande
  workflow_dispatch:

  # Contrôle qualité planifié une fois par mois (1er du mois à 03:00 UTC)
  schedule:
    - cron: '0 3 1 * *'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  lint:
    name: Lint and Validate (core; blocking)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # Sur pull_request_target, on analyse le HEAD de la PR
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Setup Node.js (for shared Stylelint configs)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install stylelint shared config
        run: npm i --no-save stylelint-config-standard@latest

      - name: Run super-linter (full, blocking)
        uses: super-linter/super-linter@v7.4.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          VALIDATE_ALL_CODEBASE: true
          LOG_LEVEL: DEBUG
          OUTPUT_DETAILS: detailed
          OUTPUT_FOLDER: super-linter-output
          CREATE_LOG_FILE: true
          # Include-only mode: enable selected linters; do not set any VALIDATE_* to false
          VALIDATE_GITHUB_ACTIONS: true
          VALIDATE_GIT_MERGE_CONFLICT_MARKERS: true
          VALIDATE_HTML: true
          VALIDATE_CSS: true
          VALIDATE_MARKDOWN: true
          VALIDATE_JSON: true
          VALIDATE_YAML: true
          VALIDATE_JAVASCRIPT_ES: true
          VALIDATE_GITLEAKS: true
          GITLEAKS_CONFIG: ".gitleaks.toml"
          FILTER_REGEX_EXCLUDE: 'images/.*\.html|social-assets/.*\.html|brand-assets/.*\.html'

      - name: Install linters CLIs (stylelint, htmlhint, markdownlint)
        run: |
          npm i --no-save stylelint htmlhint markdownlint-cli

      - name: Stylelint report (non-blocking)
        if: always()
        run: |
          set -o pipefail
          npx stylelint "**/*.css" --formatter verbose | tee stylelint-report.txt || true

      - name: HTMLHint report (non-blocking)
        if: always()
        run: |
          set -o pipefail
          npx htmlhint --config .htmlhintrc --format stylish "**/*.html" | tee htmlhint-report.txt || true

      - name: Markdownlint report (non-blocking)
        if: always()
        run: |
          set -o pipefail
          npx markdownlint "**/*.md" --config .markdownlint.json | tee markdownlint-report.txt || true

      - name: Upload Stylelint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: stylelint-report
          path: stylelint-report.txt
          if-no-files-found: warn

      - name: Upload HTMLHint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: htmlhint-report
          path: htmlhint-report.txt
          if-no-files-found: warn

      - name: Upload Markdownlint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: markdownlint-report
          path: markdownlint-report.txt
          if-no-files-found: warn

      - name: Upload Super-Linter summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: super-linter-summary
          path: super-linter-output/super-linter-summary.md
          if-no-files-found: warn
        continue-on-error: true

      - name: Upload Super-Linter log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: super-linter-log
          path: super-linter.log
          if-no-files-found: warn
        continue-on-error: true

      # Les erreurs détaillées sont imprimées par Super-Linter directement dans les logs
      # (OUTPUT_DETAILS=detailed). Pas besoin d'artefacts dédiés.

  codeql:
    name: CodeQL (SAST)
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: javascript
      - name: Autobuild
        uses: github/codeql-action/autobuild@v4
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4

  accessibility:
    name: Accessibility (Pa11y)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Start static server and run Pa11y CI (JSON report)
        run: |
          npx http-server -p 8080 -c-1 . &
          npx wait-on http://localhost:8080
          set -o pipefail
          npx pa11y-ci --json | tee pa11y-report.json
      - name: Upload Pa11y report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pa11y-report
          path: pa11y-report.json
          if-no-files-found: warn

  npm_audit:
    name: Dependencies Audit (npm audit)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install deps
        run: npm install --no-fund --no-audit
      - name: Audit for vulnerabilities (high+)
        run: npm audit --audit-level=high